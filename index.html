<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NZ Trip â€” Apr 25 â€“ May 3, 2025</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: #0d1117;
  color: #e6edf3;
  overflow: hidden;
  height: 100vh; height: 100dvh;
}

/* â•â• HEADER â•â• */
header {
  position: fixed; top: 0; left: 0; right: 0; height: 56px;
  background: linear-gradient(135deg, #161b22 0%, #1a2332 100%);
  border-bottom: 1px solid #30363d;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; z-index: 1000;
}
.header-title { display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1; }
.nz-flag { font-size: 20px; flex-shrink: 0; }
.header-title h1 { font-size: 16px; font-weight: 700; color: #58a6ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-title p { font-size: 12px; color: #8b949e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-stats { display: flex; gap: 12px; flex-shrink: 0; }
.stat { text-align: center; }
.stat .val { font-size: 16px; font-weight: 700; color: #58a6ff; line-height: 1.2; }
.stat .lbl { font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.4px; }

/* â•â• MAP + SIDEBAR BASE â•â• */
#map { position: fixed; top: 56px; z-index: 1; }
.sidebar { position: fixed; background: #161b22; z-index: 500; overflow: hidden; display: flex; flex-direction: column; }
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-track { background: #161b22; }
.sidebar::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }

/* â•â• TAB BAR â•â• */
.tab-bar {
  display: flex; flex-shrink: 0;
  border-bottom: 1px solid #21262d;
  background: #161b22;
}
.tab-btn {
  flex: 1; padding: 10px 4px; border: none; background: none;
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600;
  color: #8b949e; cursor: pointer; transition: all 0.15s ease;
  border-bottom: 2px solid transparent; margin-bottom: -1px;
  display: flex; align-items: center; justify-content: center; gap: 4px;
}
.tab-btn:hover { color: #c9d1d9; background: rgba(255,255,255,0.03); }
.tab-btn.active { color: #58a6ff; border-bottom-color: #58a6ff; }
.tab-btn.active.t-lodging { color: #3fb950; border-bottom-color: #3fb950; }
.tab-btn.active.t-dining { color: #f0883e; border-bottom-color: #f0883e; }

/* â•â• TAB CONTENT â•â• */
#tab-content { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #30363d #161b22; }

/* â•â• DESKTOP â•â• */
@media (min-width: 641px) {
  .sidebar-handle, .sidebar-toggle-hint { display: none !important; }
  .sidebar { top: 56px; left: 0; bottom: 0; width: 340px; border-right: 1px solid #30363d; }
  #map { left: 340px; right: 0; bottom: 0; }
}

/* â•â• MOBILE â•â• */
@media (max-width: 640px) {
  .header-title p { display: none; }
  .stat:nth-child(3), .stat:nth-child(4) { display: none; }
  #map { left: 0; right: 0; bottom: 0; }
  .sidebar {
    bottom: 0; left: 0; right: 0; height: 110px;
    border-top: 1px solid #30363d; border-radius: 18px 18px 0 0;
    transition: height 0.32s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar.open { height: 74dvh; }
  .sidebar-handle {
    display: flex !important; justify-content: center; padding: 10px 0 4px; cursor: pointer; flex-shrink: 0;
  }
  .sidebar-handle::before {
    content: ''; width: 36px; height: 4px; background: #484f58; border-radius: 2px; display: block;
  }
  .tab-btn {
    font-size: 13px;
    padding: 14px 4px;
    gap: 6px;
    flex-direction: column;
  }
  .tab-btn .tab-icon { font-size: 22px; }
  .tab-btn .tab-label { font-size: 13px; font-weight: 600; }
  .sidebar-toggle-hint { display: none; }
}

/* â•â• SECTION HEADER â•â• */
.section-header {
  padding: 14px 20px 10px; font-size: 12px; font-weight: 700;
  color: #8b949e; text-transform: uppercase; letter-spacing: 1px;
  border-bottom: 1px solid #21262d; background: #0d1117;
  position: sticky; top: 0; z-index: 10;
  display: flex; align-items: center; justify-content: space-between;
}
.section-header .updated-tag {
  font-size: 10px; font-weight: 500; text-transform: none; letter-spacing: 0;
  color: #484f58; background: rgba(255,255,255,0.04); border: 1px solid #21262d;
  border-radius: 8px; padding: 2px 8px;
}

/* â•â• STATUS BADGES â•â• */
.status-badge {
  display: inline-flex; align-items: center; gap: 4px;
  border-radius: 10px; padding: 3px 10px; font-size: 12px; font-weight: 600;
  margin-bottom: 8px;
}
.status-badge.booked {
  background: rgba(63,185,80,0.14); border: 1px solid rgba(63,185,80,0.35); color: #3fb950;
}
.status-badge.deciding {
  background: rgba(227,179,65,0.10); border: 1px solid rgba(227,179,65,0.28); color: #e3b341;
}
.status-badge.backup {
  background: rgba(139,148,158,0.08); border: 1px solid rgba(139,148,158,0.20); color: #6e7681;
}

/* â•â• DAY CARDS (Itinerary) â•â• */
.day-card {
  border-bottom: 1px solid #21262d; cursor: pointer;
  transition: background 0.15s ease; position: relative;
}
.day-card:hover { background: #1c2128; }
.day-card.active { background: #1c2128; border-left: 3px solid var(--day-color); }
.day-header { padding: 12px 20px 8px; display: flex; align-items: flex-start; gap: 12px; }
.day-badge {
  width: 34px; height: 34px; border-radius: 50%; background: var(--day-color);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.day-meta { flex: 1; }
.day-label { font-size: 15px; font-weight: 600; color: #e6edf3; line-height: 1.3; }
.day-date { font-size: 13px; color: #8b949e; margin-top: 1px; }
.day-location { font-size: 14px; font-weight: 500; color: var(--day-color); margin-top: 2px; }
.day-activities { padding: 0 20px 12px 66px; }
.activity { display: flex; align-items: flex-start; gap: 8px; padding: 3px 0; font-size: 13px; color: #8b949e; line-height: 1.5; }
.activity .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--day-color); flex-shrink: 0; margin-top: 6px; opacity: 0.7; }
.stay-tag {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(88,166,255,0.1); border: 1px solid rgba(88,166,255,0.2);
  border-radius: 12px; padding: 4px 10px; font-size: 12px; color: #79c0ff; margin-top: 6px;
}
.vibes-pill {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(255,255,255,0.05); border-radius: 10px; padding: 4px 10px;
  font-size: 12px; color: #c9d1d9; margin-top: 4px; font-style: italic;
}

/* â•â• LOCATION GROUP CARD (Lodging + Dining) â•â• */
.location-group { border-bottom: 1px solid #21262d; }
.location-group-header {
  padding: 12px 20px 10px; display: flex; align-items: center; gap: 10px;
  background: #0f1318;
}
.location-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}
.location-group-name { font-size: 15px; font-weight: 700; color: #e6edf3; }
.location-group-days { font-size: 12px; color: #8b949e; margin-top: 1px; }

/* â•â• LODGING CARD â•â• */
.lodging-card {
  margin: 0 16px 12px; padding: 12px 14px;
  background: #1c2128; border: 1px solid #30363d; border-radius: 10px;
  transition: border-color 0.15s ease;
}
.lodging-card:first-of-type { margin-top: 12px; }
.lodging-card:hover { border-color: #3fb950; }
.lodging-card.is-booked { border-color: rgba(63,185,80,0.4); }
.lodging-name { font-size: 15px; font-weight: 600; color: #e6edf3; margin-bottom: 5px; }
.lodging-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.lodging-type {
  font-size: 12px; font-weight: 500; color: #3fb950;
  background: rgba(63,185,80,0.1); border: 1px solid rgba(63,185,80,0.2);
  border-radius: 8px; padding: 3px 8px;
}
.lodging-price { font-size: 13px; color: #f0883e; font-weight: 600; }
.lodging-cost {
  display: flex; align-items: baseline; gap: 8px; margin-bottom: 10px;
  background: rgba(63,185,80,0.07); border: 1px solid rgba(63,185,80,0.15);
  border-radius: 8px; padding: 8px 12px;
}
.cost-amount { font-size: 16px; font-weight: 700; color: #3fb950; }
.cost-detail { font-size: 12px; color: #8b949e; }
.lodging-note { font-size: 13px; color: #8b949e; line-height: 1.5; margin-bottom: 10px; }

/* â•â• DINING CARD â•â• */
.dining-card {
  margin: 0 16px 12px; padding: 12px 14px;
  background: #1c2128; border: 1px solid #30363d; border-radius: 10px;
  transition: border-color 0.15s ease;
}
.dining-card:first-of-type { margin-top: 12px; }
.dining-card:hover { border-color: #f0883e; }
.dining-card.is-booked { border-color: rgba(240,136,62,0.4); }
.dining-name { font-size: 15px; font-weight: 600; color: #e6edf3; margin-bottom: 5px; }
.dining-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.dining-type {
  font-size: 12px; font-weight: 500; color: #f0883e;
  background: rgba(240,136,62,0.1); border: 1px solid rgba(240,136,62,0.2);
  border-radius: 8px; padding: 3px 8px;
}
.dining-dish {
  font-size: 13px; color: #c9d1d9; margin-bottom: 6px;
  display: flex; align-items: flex-start; gap: 5px; line-height: 1.5;
}
.dining-dish::before { content: 'ğŸ´'; font-size: 12px; flex-shrink: 0; margin-top: 1px; }
.dining-vibe { font-size: 13px; color: #8b949e; font-style: italic; line-height: 1.5; margin-bottom: 10px; }

/* â•â• CARD ACTION BUTTONS â•â• */
.card-actions { display: flex; gap: 8px; margin-top: 2px; }
.card-btn {
  flex: 1; padding: 9px 10px; border-radius: 8px; border: 1px solid #30363d;
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600;
  cursor: pointer; text-decoration: none; text-align: center;
  display: flex; align-items: center; justify-content: center; gap: 5px;
  transition: all 0.15s ease; background: #0d1117; color: #c9d1d9;
}
.card-btn:hover { border-color: #58a6ff; color: #58a6ff; background: rgba(88,166,255,0.08); }
.card-btn.book { border-color: rgba(63,185,80,0.4); color: #3fb950; background: rgba(63,185,80,0.06); }
.card-btn.book:hover { border-color: #3fb950; background: rgba(63,185,80,0.12); }
.card-btn.maps { border-color: rgba(88,166,255,0.3); color: #79c0ff; background: rgba(88,166,255,0.06); }
.card-btn.maps:hover { border-color: #58a6ff; background: rgba(88,166,255,0.12); }

/* â•â• POPUP STYLES â•â• */
.leaflet-popup-content-wrapper {
  background: #161b22 !important; border: 1px solid #30363d !important;
  border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important; padding: 0 !important;
}
.leaflet-popup-content { margin: 0 !important; min-width: 240px; }
.leaflet-popup-tip-container { display: none; }
.leaflet-popup-close-button { color: #8b949e !important; top: 8px !important; right: 8px !important; font-size: 18px !important; }
.popup-inner { padding: 16px 18px 14px; }
.popup-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--popup-color); border-radius: 20px; padding: 5px 12px;
  font-size: 12px; font-weight: 600; color: #fff; margin-bottom: 10px;
}
.popup-title { font-size: 17px; font-weight: 700; color: #e6edf3; margin-bottom: 10px; line-height: 1.3; }
.popup-items { list-style: none; display: flex; flex-direction: column; gap: 6px; }
.popup-items li { display: flex; align-items: flex-start; gap: 7px; font-size: 13px; color: #8b949e; line-height: 1.5; }
.popup-items li::before { content: 'â†’'; color: var(--popup-color); font-size: 11px; margin-top: 2px; flex-shrink: 0; }
.popup-footer { margin-top: 10px; padding-top: 10px; border-top: 1px solid #21262d; font-size: 13px; color: #79c0ff; }
.popup-photo-wrap { position: relative; margin: -16px -18px 12px; border-radius: 12px 12px 0 0; overflow: hidden; height: 140px; }
.popup-photo-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; filter: brightness(0.75); }
.popup-meme-overlay {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.85));
  padding: 20px 12px 10px; font-size: 13px; font-weight: 600; color: #fff; line-height: 1.4; font-style: italic;
}
.drive-badge {
  background: rgba(255,255,255,0.06); border: 1px solid #30363d; border-radius: 8px;
  padding: 8px 12px; font-size: 13px; color: #8b949e; margin-bottom: 8px;
  display: flex; align-items: center; gap: 5px;
}

/* â•â• LEGEND â•â• */
.legend {
  background: rgba(22,27,34,0.95); border: 1px solid #30363d; border-radius: 10px;
  padding: 12px 14px; backdrop-filter: blur(10px);
}
.legend-title { font-size: 12px; font-weight: 600; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #c9d1d9; margin-bottom: 5px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* â•â• MARKERS â•â• */
.custom-marker {
  display: flex; align-items: center; justify-content: center; border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3); font-weight: 700; color: white; font-size: 12px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s;
}
.custom-marker:hover { transform: scale(1.15); }
.route-label {
  background: rgba(22,27,34,0.9); border: 1px solid #30363d; border-radius: 8px;
  padding: 2px 7px; font-size: 10px; color: #8b949e; white-space: nowrap;
}
.card-carousel{position:relative;width:100%;height:200px;overflow:hidden;border-radius:10px 10px 0 0;background:#0d1117;flex-shrink:0}
.carousel-track{display:flex;height:100%;transition:transform .3s ease;will-change:transform}
.carousel-slide{min-width:100%;height:100%;flex-shrink:0}
.carousel-slide img{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.85)}
.carousel-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:2}
.carousel-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.35);cursor:pointer;transition:background .2s;border:none;padding:0}
.carousel-dot.active{background:#fff}
.carousel-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.55);border:none;color:#fff;font-size:18px;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2;opacity:0;transition:opacity .2s;line-height:1}
.card-carousel:hover .carousel-arrow{opacity:1}
.carousel-arrow.prev{left:8px}
.carousel-arrow.next{right:8px}
@media(max-width:640px){.card-carousel{height:180px}.carousel-arrow{display:none!important}}
.lodging-card,.dining-card,.day-card{overflow:hidden}
</style>
</head>
<body>

<header>
  <div class="header-title">
    <span class="nz-flag">ğŸ‡³ğŸ‡¿</span>
    <div>
      <h1>South Island Road Trip</h1>
      <p>Christchurch â†’ Lake Tekapo â†’ Mt Cook â†’ Queenstown</p>
    </div>
  </div>
  <div class="header-stats">
    <div class="stat"><div class="val">9</div><div class="lbl">Days</div></div>
    <div class="stat"><div class="val">6</div><div class="lbl">Pax</div></div>
    <div class="stat"><div class="val">Apr 25</div><div class="lbl">Depart</div></div>
    <div class="stat"><div class="val">May 3</div><div class="lbl">Return</div></div>
  </div>
</header>

<div id="map"></div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-handle" id="sidebar-handle"></div>
  <div class="tab-bar" id="tab-bar">
    <button class="tab-btn active t-itinerary" data-tab="itinerary"><span class="tab-icon">ğŸ“</span><span class="tab-label">Itinerary</span></button>
    <button class="tab-btn t-lodging" data-tab="lodging"><span class="tab-icon">ğŸ </span><span class="tab-label">Lodging</span></button>
    <button class="tab-btn t-dining" data-tab="dining"><span class="tab-icon">ğŸ½ï¸</span><span class="tab-label">Dining</span></button>
  </div>
  <div id="tab-content"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LAST_UPDATED = "Feb 25, 2026";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const days = [
  {
    id: 1, label: "D1 (Sat)", date: "Apr 25", location: "Christchurch",
    locationId: "christchurch", coords: [-43.5321, 172.6362], color: "#58a6ff",
    activities: ["Land AKL/SYD Airport", "Domestic flight to Christchurch"],
    stay: "Christchurch BnB", drive: null,
    photos: ["https://upload.wikimedia.org/wikipedia/commons/b/bd/The_%22Brill%22_Tram_178.New_Regent_St_Christchurch._%2811510530335%29.jpg","https://upload.wikimedia.org/wikipedia/commons/5/54/Christchurch_Botanic_Gardens_-_geograph.org.uk_-_697988.jpg","https://upload.wikimedia.org/wikipedia/commons/e/e4/Christchurch_Art_Gallery_from_the_square.JPG"],
    meme: "\"It's called the Garden City\" ğŸŒ¸ ...bro we just flew 10 hours",
    vibes: "Tired but excited ğŸ˜´âœˆï¸"
  },
  {
    id: 2, label: "D2 (Sun)", date: "Apr 26", location: "Lake Tekapo",
    locationId: "tekapo", coords: [-44.0038, 170.4786], color: "#3fb950",
    activities: ["3 hr drive from Christchurch", "Pit stops: Ashburton, Methven, Geraldine, Rakaia Gorge, Fairlie", "Tour around Lake Tekapo"],
    stay: "BnB Lodge with hot tub ğŸ›", drive: "3 hrs from Christchurch",
    photos: ["https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg","https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Lake_Tekapo_-_New_Zealand.jpg/1280px-Lake_Tekapo_-_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/1/18/Lake_Tekapo_and_lupins.jpg"],
    meme: "Sheep spotted count: lost track after 847 ğŸ‘ğŸ‘ğŸ‘",
    vibes: "Road trip mode activated ğŸš—ğŸµ"
  },
  {
    id: 3, label: "D3 (Mon)", date: "Apr 27", location: "Lake Tekapo",
    locationId: "tekapo", coords: [-44.0038, 170.4786], color: "#3fb950",
    activities: ["Peninsula Walkway / Lakeside Trail", "Lake Alexandrina", "Tekapo Springs"],
    stay: "BnB Lodge with hot tub ğŸ›", drive: null,
    photos: ["https://upload.wikimedia.org/wikipedia/commons/5/57/Church_of_the_Good_Shepherd%2C_Tekapo_01.jpg","https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg","https://upload.wikimedia.org/wikipedia/commons/1/18/Lake_Tekapo_and_lupins.jpg"],
    meme: "The lake is THIS blue in real life. Instagram didn't lie for once ğŸ˜¤",
    vibes: "Main character energy ğŸ’…ğŸ”ï¸"
  },
  {
    id: 4, label: "D4 (Tue)", date: "Apr 28", location: "Mt Cook Village",
    locationId: "mtcook", coords: [-43.7359, 170.0966], color: "#f0883e",
    activities: ["1.5 hr drive to Aoraki/Mt Cook Village", "Mt Cook Alpine Salmon Shop", "Picnic next to Lake Pukaki", "Tasman Glacier View Track (1.5km ~40 mins)"],
    stay: "Mt Cook Village BnB", drive: "1.5 hrs from Lake Tekapo",
    photos: ["https://upload.wikimedia.org/wikipedia/commons/0/08/LakePukakiNov232024_01.jpg","https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg","https://upload.wikimedia.org/wikipedia/commons/4/44/Tasman_Glacier.jpg"],
    meme: "One does not simply walk into Mt Cook... actually you can. There are signs. ğŸ§™â€â™‚ï¸",
    vibes: "Full Tolkien mode ğŸ”ï¸ğŸ’"
  },
  {
    id: 5, label: "D5 (Wed)", date: "Apr 29", location: "Mt Cook Village",
    locationId: "mtcook", coords: [-43.7359, 170.0966], color: "#f0883e",
    activities: ["Hooker Valley Track (3â€“4 hrs, flat road)", "or Kea Point Track (3km ~2 hrs, stairs)", "Glentanner Park / Aoraki Alpine Lodge", "Outdoor BBQ picnic"],
    stay: "Mt Cook Village BnB", drive: null,
    photos: ["https://upload.wikimedia.org/wikipedia/commons/2/23/Stocking_Stream_Shelter_in_Hooker_Valley_in_front_of_Aoraki_Mount_Cook_Range.jpg","https://upload.wikimedia.org/wikipedia/commons/1/10/Hooker_Lake_and_Aoraki.jpg","https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg"],
    meme: "\"It's flat, easy walking\" they said ğŸ˜®â€ğŸ’¨ *dies on the return leg*",
    vibes: "We're hikers now apparently ğŸ¥¾ğŸ˜…"
  },
  {
    id: 6, label: "D6 (Thu)", date: "Apr 30", location: "Gibbston Valley",
    locationId: "gibbston", coords: [-45.0132, 168.9481], color: "#bc8cff",
    activities: ["2.5 hr drive to Cromwell", "Winery visits in Gibbston Valley"],
    stay: "Winery cottage ğŸ·", drive: "2.5 hrs from Mt Cook",
    photos: ["https://upload.wikimedia.org/wikipedia/commons/1/1c/Vineyard_in_Gibbston_Valley_in_South_Island%2C_New_Zealand_-_Central_Otago_wine_region.jpg","https://upload.wikimedia.org/wikipedia/commons/4/40/Peregrine_Winery%2C_Gibbston.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5d/Central_Otago_wine_region.jpg"],
    meme: "\"Wine tasting\" = technically drinking before noon. But make it classy ğŸ·ğŸ˜‡",
    vibes: "Sophisticated degenerates ğŸ‡âœ¨"
  },
  {
    id: 7, label: "D7 (Fri)", date: "May 1", location: "Queenstown",
    locationId: "queenstown", coords: [-45.0312, 168.6626], color: "#ff7b72",
    activities: ["Optional: morning winery visit", "1 hr drive to Queenstown"],
    stay: "Queenstown BnB", drive: "~1 hr from Gibbston",
    photos: ["https://upload.wikimedia.org/wikipedia/commons/c/c9/Queenstown_1_%288168013172%29.jpg","https://upload.wikimedia.org/wikipedia/commons/a/a9/Queenstown%2C_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/2/29/Queenstown_at_night.jpg"],
    meme: "Queenstown: where you plan to bungee jump and end up just eating burgers instead ğŸ”",
    vibes: "Adventure capital... of eating ğŸ”ï¸ğŸ”"
  },
  {
    id: 8, label: "D8 (Sat)", date: "May 2", location: "Queenstown",
    locationId: "queenstown", coords: [-45.0312, 168.6626], color: "#ff7b72",
    activities: ["TSS Earnslaw cruise? ğŸš¢", "Explore Queenstown"],
    stay: "Queenstown BnB", drive: null,
    photos: ["https://upload.wikimedia.org/wikipedia/commons/1/19/TSS_Earnslaw.jpg","https://upload.wikimedia.org/wikipedia/commons/c/c9/Queenstown_1_%228168013172%29.jpg","https://upload.wikimedia.org/wikipedia/commons/a/a9/Queenstown%2C_New_Zealand.jpg"],
    meme: "Boarding a 112-year-old steam ship. Peak confidence. No notes. ğŸš¢ğŸ”¥",
    vibes: "Last full day, maximum chaos ğŸ‰"
  },
  {
    id: 9, label: "D9 (Sun)", date: "May 3", location: "Depart",
    locationId: "queenstown", coords: [-45.0312, 168.6626], color: "#8b949e",
    activities: ["Depart to AKL/SYD Airport", "Transit to HKG ğŸ "],
    stay: null, drive: null,
    photos: ["https://upload.wikimedia.org/wikipedia/commons/c/c8/Auckland_International_Airport_2017_aerial.png","https://upload.wikimedia.org/wikipedia/commons/1/19/TSS_Earnslaw.jpg","https://upload.wikimedia.org/wikipedia/commons/c/c9/Queenstown_1_%228168013172%29.jpg"],
    meme: "Goodbye NZ ğŸ˜­ Hello 12-hour flight and 47 unread emails ğŸ’€",
    vibes: "Post-trip depression loading... ğŸ¥²"
  }
];

const locations = [
  {
    id: "christchurch", name: "Christchurch", days: [1],
    coords: [-43.5321, 172.6362], color: "#58a6ff",
    lodging: [
      {
        name: "The George Hotel",
        type: "Boutique Hotel", price: "$$$",
        costNote: "~NZD $1,050â€“1,500/night", costDetail: "3 rooms for 6 pax",
        note: "Best address in Christchurch. Parkside location, impeccable service, beautiful rooms.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/7/7a/The_George%2C_Christchurch%2C_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/7/7a/The_George%2C_Christchurch_043.JPG"],
        status: "deciding",
        coords: [-43.5274, 172.6417],
        bookingUrl: "https://www.thegeorge.com/",
        mapsUrl: "https://maps.google.com/?q=The+George+Hotel+Christchurch"
      },
      {
        name: "Eliza's Manor",
        type: "Heritage B&B", price: "$$",
        costNote: "~NZD $450â€“700/night", costDetail: "3 rooms for 6 pax",
        note: "Victorian mansion, 10 min walk to city centre. Elegant, personal, great breakfast.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/e/e4/Christchurch_Art_Gallery_from_the_square.JPG","https://upload.wikimedia.org/wikipedia/commons/b/bd/The_%22Brill%22_Tram_178.New_Regent_St_Christchurch._%2811510530335%29.jpg"],
        status: "deciding",
        coords: [-43.5315, 172.6381],
        bookingUrl: "https://www.booking.com/hotel/nz/elizas-manor.html",
        mapsUrl: "https://maps.google.com/?q=Elizas+Manor+Christchurch"
      }
    ],
    dining: [
      {
        name: "Hello Sunday",
        type: "All-day brunch cafÃ©",
        dish: "Smashed avo toast + cold brew",
        vibe: "â˜€ï¸ Best brunch spot in CHC â€” lively, packed on weekends",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/5/54/Christchurch_Botanic_Gardens_-_geograph.org.uk_-_697988.jpg","https://upload.wikimedia.org/wikipedia/commons/b/bd/The_%22Brill%22_Tram_178.New_Regent_St_Christchurch._%2811510530335%29.jpg"],
        status: "deciding",
        coords: [-43.5292, 172.6368],
        mapsUrl: "https://maps.google.com/?q=Hello+Sunday+Christchurch+NZ"
      },
      {
        name: "Fiddlesticks",
        type: "Wine bar / restaurant",
        dish: "Local pinot noir + shared boards",
        vibe: "ğŸ· Sophisticated but relaxed â€” perfect first-night dinner",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/e/e4/Christchurch_Art_Gallery_from_the_square.JPG","https://upload.wikimedia.org/wikipedia/commons/b/bd/The_%22Brill%22_Tram_178.New_Regent_St_Christchurch._%2811510530335%29.jpg"],
        status: "deciding",
        coords: [-43.5301, 172.6352],
        mapsUrl: "https://maps.google.com/?q=Fiddlesticks+Christchurch+NZ"
      },
      {
        name: "The Pog",
        type: "Gastropub",
        dish: "Burger + whatever's on tap",
        vibe: "ğŸº Chill spot if you just want to decompress after the flight",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/b/bd/The_%22Brill%22_Tram_178.New_Regent_St_Christchurch._%2811510530335%29.jpg","https://upload.wikimedia.org/wikipedia/commons/5/54/Christchurch_Botanic_Gardens_-_geograph.org.uk_-_697988.jpg"],
        status: "deciding",
        coords: [-43.5310, 172.6340],
        mapsUrl: "https://maps.google.com/?q=The+Pog+Christchurch+NZ"
      }
    ]
  },
  {
    id: "tekapo", name: "Lake Tekapo", days: [2, 3],
    coords: [-44.0038, 170.4786], color: "#3fb950",
    lodging: [
      {
        name: "Peppers Bluewater Resort",
        type: "Lakefront Resort", price: "$$$",
        costNote: "~NZD $550â€“800/night", costDetail: "1Ã— 3-bedroom apartment fits 6",
        note: "Right on the lakefront. Stunning turquoise views, spa, outdoor hot pools. The one.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg","https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Lake_Tekapo_-_New_Zealand.jpg/1280px-Lake_Tekapo_-_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/5/57/Church_of_the_Good_Shepherd%2C_Tekapo_01.jpg"],
        status: "deciding",
        coords: [-44.0042, 170.4751],
        bookingUrl: "https://www.peppers.co.nz/bluewater/",
        mapsUrl: "https://maps.google.com/?q=Peppers+Bluewater+Resort+Lake+Tekapo"
      },
      {
        name: "Tailor Made Tekapo",
        type: "Hostel / B&B", price: "$",
        costNote: "~NZD $280â€“420/night", costDetail: "3 rooms for 6 pax",
        note: "Small, cozy, hosts are legends. Private hot tub with direct lake views. Feels like home.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/1/18/Lake_Tekapo_and_lupins.jpg","https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg"],
        status: "deciding",
        coords: [-44.0058, 170.4802],
        bookingUrl: "https://www.tekapohostelnz.com/",
        mapsUrl: "https://maps.google.com/?q=Tailor+Made+Tekapo+Accommodation"
      }
    ],
    dining: [
      {
        name: "Kohan Restaurant",
        type: "Japanese",
        dish: "Salmon sashimi (local Mt Cook salmon â€” seriously)",
        vibe: "ğŸ£ Surprisingly legit Japanese in the middle of NZ's south island",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg","https://upload.wikimedia.org/wikipedia/commons/5/57/Church_of_the_Good_Shepherd%2C_Tekapo_01.jpg"],
        status: "deciding",
        coords: [-44.0031, 170.4789],
        mapsUrl: "https://maps.google.com/?q=Kohan+Restaurant+Lake+Tekapo"
      },
      {
        name: "Mackenzie's Bar & Grill",
        type: "NZ Classic",
        dish: "Lamb rack + Mackenzie Basin pinot",
        vibe: "ğŸ¥© Classic NZ cooking, solid every time, lake views",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Lake_Tekapo_-_New_Zealand.jpg/1280px-Lake_Tekapo_-_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg"],
        status: "deciding",
        coords: [-44.0044, 170.4777],
        mapsUrl: "https://maps.google.com/?q=Mackenzies+Bar+Grill+Lake+Tekapo"
      },
      {
        name: "Run 76 CafÃ©",
        type: "CafÃ©",
        dish: "Flat white + cabinet food",
        vibe: "â˜• Morning fuel before the Peninsula Walkway",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/1/18/Lake_Tekapo_and_lupins.jpg","https://upload.wikimedia.org/wikipedia/commons/6/65/LakeTekapoNov242024_05.jpg"],
        status: "deciding",
        coords: [-44.0022, 170.4801],
        mapsUrl: "https://maps.google.com/?q=Run+76+Cafe+Lake+Tekapo"
      }
    ]
  },
  {
    id: "mtcook", name: "Mt Cook Village", days: [4, 5],
    coords: [-43.7359, 170.0966], color: "#f0883e",
    lodging: [
      {
        name: "The Hermitage Hotel",
        type: "Iconic Mountain Hotel", price: "$$$",
        costNote: "~NZD $840â€“1,400/night", costDetail: "3 rooms for 6 pax",
        note: "THE Mt Cook hotel. Panoramic Aoraki views, been here since 1884. Book the mountain-view room.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/9/94/00_1700_Aoraki_Mount_Cook%2CThe_Hermitage_-_Mount-Cook-Nationalpark.jpg","https://upload.wikimedia.org/wikipedia/commons/8/8d/The_Hermitage_hotel%2C_Mount_Cook%2C_New_Zealand_-_panoramio.jpg","https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg"],
        status: "deciding",
        coords: [-43.7359, 170.0966],
        bookingUrl: "https://www.hermitage.co.nz/stay/hermitage-hotel/",
        mapsUrl: "https://maps.google.com/?q=The+Hermitage+Hotel+Mt+Cook"
      },
      {
        name: "Glentanner Park Centre",
        type: "Cabins / Glamping", price: "$",
        costNote: "~NZD $200â€“400/night", costDetail: "2â€“3 cabins for 6 pax",
        note: "Campsites and self-contained cabins at the base of Aoraki. Budget pick with epic views.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg","https://upload.wikimedia.org/wikipedia/commons/0/08/LakePukakiNov232024_01.jpg"],
        status: "deciding",
        coords: [-43.8050, 170.1000],
        bookingUrl: "https://www.glentanner.co.nz/",
        mapsUrl: "https://maps.google.com/?q=Glentanner+Park+Centre+Mt+Cook"
      }
    ],
    dining: [
      {
        name: "Old Mountaineers' CafÃ©",
        type: "CafÃ© / Bar",
        dish: "Venison pie + Speight's Old Dark",
        vibe: "ğŸ”ï¸ Legendary. Alpine hikers fuel up here. Best views of Aoraki while you eat.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg","https://upload.wikimedia.org/wikipedia/commons/2/23/Stocking_Stream_Shelter_in_Hooker_Valley_in_front_of_Aoraki_Mount_Cook_Range.jpg"],
        status: "deciding",
        coords: [-43.7355, 170.0972],
        mapsUrl: "https://maps.google.com/?q=Old+Mountaineers+Cafe+Mt+Cook+Village"
      },
      {
        name: "Panorama Restaurant",
        type: "Fine dining",
        dish: "Set degustation menu with mountain views",
        vibe: "âœ¨ Splurge night â€” floor-to-ceiling windows facing Aoraki. Worth it once.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/8/8d/The_Hermitage_hotel%2C_Mount_Cook%2C_New_Zealand_-_panoramio.jpg","https://upload.wikimedia.org/wikipedia/commons/f/f6/Aoraki_Mount_Cook_-_from_the_south.jpg"],
        status: "deciding",
        coords: [-43.7361, 170.0960],
        mapsUrl: "https://maps.google.com/?q=Panorama+Restaurant+Hermitage+Mt+Cook"
      }
    ]
  },
  {
    id: "gibbston", name: "Gibbston Valley", days: [6],
    coords: [-45.0132, 168.9481], color: "#bc8cff",
    lodging: [
      {
        name: "Kinross Cottages",
        type: "Vineyard Cottage", price: "$$$",
        costNote: "~NZD $1,200â€“1,800/night", costDetail: "3 cottages for 6 pax (2/cottage)",
        note: "Sleep in the vineyard. Wake up to rows of pinot noir. Cellar door 50m from your door.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/1/1c/Vineyard_in_Gibbston_Valley_in_South_Island%2C_New_Zealand_-_Central_Otago_wine_region.jpg","https://upload.wikimedia.org/wikipedia/commons/4/40/Peregrine_Winery%2C_Gibbston.jpg"],
        status: "deciding",
        coords: [-45.0120, 168.9450],
        bookingUrl: "https://kinross.nz/pages/vineyard-cottages",
        mapsUrl: "https://maps.google.com/?q=Kinross+Gibbston+Valley+Queenstown"
      },
      {
        name: "Amisfield Winery",
        type: "Wine Estate Stay", price: "$$$",
        costNote: "~NZD $800â€“1,200/night", costDetail: "Private villa â€” contact direct",
        note: "Beautiful estate stay. One of NZ's best pinot producers. Book months in advance.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/4/40/Peregrine_Winery%2C_Gibbston.jpg","https://upload.wikimedia.org/wikipedia/commons/1/1c/Vineyard_in_Gibbston_Valley_in_South_Island%2C_New_Zealand_-_Central_Otago_wine_region.jpg"],
        status: "deciding",
        coords: [-44.9890, 168.8950],
        bookingUrl: "https://amisfield.co.nz/",
        mapsUrl: "https://maps.google.com/?q=Amisfield+Winery+Queenstown"
      }
    ],
    dining: [
      {
        name: "Amisfield Bistro",
        type: "Farm-to-table fine dining",
        dish: "'Trust the chef' menu â€” no menu, all seasonal",
        vibe: "ğŸŒ¿ One of NZ's best restaurants. Seriously. Book ahead.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/4/40/Peregrine_Winery%2C_Gibbston.jpg","https://upload.wikimedia.org/wikipedia/commons/1/1c/Vineyard_in_Gibbston_Valley_in_South_Island%2C_New_Zealand_-_Central_Otago_wine_region.jpg"],
        status: "deciding",
        coords: [-44.9890, 168.8950],
        mapsUrl: "https://maps.google.com/?q=Amisfield+Bistro+Queenstown"
      },
      {
        name: "Peregrine Wines",
        type: "Cellar door tasting",
        dish: "Pinot Noir flight + cheese board",
        vibe: "ğŸ· Iconic NZ modernist architecture + award-winning wine",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/4/40/Peregrine_Winery%2C_Gibbston.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5d/Central_Otago_wine_region.jpg"],
        status: "deciding",
        coords: [-45.0035, 168.9200],
        mapsUrl: "https://maps.google.com/?q=Peregrine+Wines+Gibbston+Valley"
      },
      {
        name: "Kinross Cellar Door & Kitchen",
        type: "Wine bar",
        dish: "Pinot Gris + shared plates",
        vibe: "ğŸ‡ Relaxed, unpretentious tasting right in the valley",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/1/1c/Vineyard_in_Gibbston_Valley_in_South_Island%2C_New_Zealand_-_Central_Otago_wine_region.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5d/Central_Otago_wine_region.jpg"],
        status: "deciding",
        coords: [-45.0120, 168.9450],
        mapsUrl: "https://maps.google.com/?q=Kinross+Cellar+Door+Gibbston"
      }
    ]
  },
  {
    id: "queenstown", name: "Queenstown", days: [7, 8, 9],
    coords: [-45.0312, 168.6626], color: "#ff7b72",
    lodging: [
      {
        name: "QT Queenstown",
        type: "Design Hotel", price: "$$$",
        costNote: "~NZD $1,050â€“1,650/night", costDetail: "3 rooms for 6 pax",
        note: "Quirky, bold design hotel. Best rooftop bar views in QT. Right on the lakefront.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/a/a9/Queenstown%2C_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/2/29/Queenstown_at_night.jpg"],
        status: "deciding",
        coords: [-45.0302, 168.6598],
        bookingUrl: "https://www.qthotels.com/queenstown/",
        mapsUrl: "https://maps.google.com/?q=QT+Hotel+Queenstown+New+Zealand"
      },
      {
        name: "The Dairy Private Hotel",
        type: "Boutique Hotel", price: "$$$$",
        costNote: "~NZD $1,350â€“2,100/night", costDetail: "3 rooms for 6 pax",
        note: "Only 13 rooms. Converted 1920s dairy. Most personal hospitality in Queenstown.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/2/29/Queenstown_at_night.jpg","https://upload.wikimedia.org/wikipedia/commons/c/c9/Queenstown_1_%288168013172%29.jpg"],
        status: "deciding",
        coords: [-45.0321, 168.6642],
        bookingUrl: "https://thedairy.co.nz/",
        mapsUrl: "https://maps.google.com/?q=The+Dairy+Private+Hotel+Queenstown"
      }
    ],
    dining: [
      {
        name: "Fergburger",
        type: "Legendary burger joint",
        dish: "The Ferg (double beef) â€” no modifications",
        vibe: "ğŸ” Non-negotiable. Queue is part of the experience. Open till 5am.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/5/55/Fergburger_restaurant.jpg","https://upload.wikimedia.org/wikipedia/commons/e/e8/Fergburger_714.jpg"],
        status: "deciding",
        coords: [-45.0315, 168.6628],
        mapsUrl: "https://maps.google.com/?q=Fergburger+Queenstown"
      },
      {
        name: "Rata",
        type: "Fine dining NZ",
        dish: "Venison + Central Otago pinot pairing",
        vibe: "âœ¨ Josh Emett's restaurant. Serious food, serious wine list.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/2/29/Queenstown_at_night.jpg","https://upload.wikimedia.org/wikipedia/commons/a/a9/Queenstown%2C_New_Zealand.jpg"],
        status: "deciding",
        coords: [-45.0308, 168.6601],
        mapsUrl: "https://maps.google.com/?q=Rata+Restaurant+Queenstown"
      },
      {
        name: "Botswana Butchery",
        type: "Steakhouse",
        dish: "Eye fillet with lake view",
        vibe: "ğŸ¥© Power dinner vibes. Lakefront terrace. Dress up slightly.",
        photos: ["https://upload.wikimedia.org/wikipedia/commons/a/a9/Queenstown%2C_New_Zealand.jpg","https://upload.wikimedia.org/wikipedia/commons/c/c9/Queenstown_1_%288168013172%29.jpg"],
        status: "deciding",
        coords: [-45.0301, 168.6589],
        mapsUrl: "https://maps.google.com/?q=Botswana+Butchery+Queenstown"
      }
    ]
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function statusBadge(status) {
  const map = {
    booked:   { cls: 'booked',   label: 'âœ… Booked' },
    deciding: { cls: 'deciding', label: 'ğŸ—³ï¸ Deciding' },
    backup:   { cls: 'backup',   label: 'Â· Backup' }
  };
  const s = map[status] || map.deciding;
  return `<div class="status-badge ${s.cls}">${s.label}</div>`;
}

function carouselHTML(photos,alt){if(!photos||!photos.length)return"";const id="c"+Math.random().toString(36).slice(2,7);if(photos.length===1)return`<div class="card-carousel" id="${id}"><div class="carousel-track"><div class="carousel-slide"><img src="${photos[0]}" alt="${alt}" loading="lazy"/></div></div></div>`;const slides=photos.map(p=>`<div class="carousel-slide"><img src="${p}" alt="${alt}" loading="lazy"/></div>`).join("");const dots=photos.map((_,i)=>`<button class="carousel-dot${i===0?" active":""}" data-c="${id}" data-i="${i}"></button>`).join("");return`<div class="card-carousel" id="${id}"><div class="carousel-track">${slides}</div><div class="carousel-dots">${dots}</div><button class="carousel-arrow prev" data-c="${id}">&#x2039;</button><button class="carousel-arrow next" data-c="${id}">&#x203a;</button></div>`;}
const _cs={};
function initCarousels(){document.querySelectorAll(".card-carousel").forEach(el=>{const id=el.id;if(!id||_cs[id])return;const track=el.querySelector(".carousel-track");if(!track)return;const total=track.children.length;if(total<=1)return;_cs[id]={cur:0,total};function go(idx){const s=_cs[id];s.cur=(idx+s.total)%s.total;track.style.transform=`translateX(-${s.cur*100}%)`;el.querySelectorAll(".carousel-dot").forEach((d,i)=>d.classList.toggle("active",i===s.cur));}el.querySelectorAll(".carousel-arrow.prev").forEach(b=>b.addEventListener("click",e=>{e.stopPropagation();go(_cs[id].cur-1);}));el.querySelectorAll(".carousel-arrow.next").forEach(b=>b.addEventListener("click",e=>{e.stopPropagation();go(_cs[id].cur+1);}));el.querySelectorAll(".carousel-dot").forEach((d,i)=>d.addEventListener("click",e=>{e.stopPropagation();go(i);}));let tx=0;el.addEventListener("touchstart",e=>{tx=e.touches[0].clientX;},{passive:true});el.addEventListener("touchend",e=>{const dx=e.changedTouches[0].clientX-tx;if(Math.abs(dx)>40)go(_cs[id].cur+(dx<0?1:-1));},{passive:true});});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const map = L.map('map', { center: [-44.2, 170.5], zoom: 7, zoomControl: false });
L.control.zoom({ position: 'topright' }).addTo(map);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: 'Â© OpenStreetMap contributors Â© CARTO',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

// Layer groups
const itineraryLayer = L.layerGroup().addTo(map);
const lodgingLayer = L.layerGroup().addTo(map);
const diningLayer = L.layerGroup().addTo(map);

// â”€â”€ REAL DRIVING ROUTES via OSRM â”€â”€
const driveSegments = [
  { label: "D2 Â· Christchurch â†’ Tekapo", color: "#3fb950", weight: 4, waypoints: [[172.6362,-43.5321],[170.4786,-44.0038]] },
  { label: "D4 Â· Tekapo â†’ Mt Cook",       color: "#f0883e", weight: 4, waypoints: [[170.4786,-44.0038],[170.0966,-43.7359]] },
  { label: "D6 Â· Mt Cook â†’ Gibbston",     color: "#bc8cff", weight: 4, waypoints: [[170.0966,-43.7359],[168.9481,-45.0132]] },
  { label: "D7 Â· Gibbston â†’ Queenstown",  color: "#ff7b72", weight: 4, waypoints: [[168.9481,-45.0132],[168.6626,-45.0312]] }
];

async function fetchRoute(waypoints) {
  const coords = waypoints.map(w => w.join(',')).join(';');
  const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.routes && data.routes[0]) {
    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
  }
  return null;
}

const routeStatus = document.createElement('div');
routeStatus.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(22,27,34,0.9);border:1px solid #30363d;border-radius:20px;padding:6px 14px;font-size:11px;color:#8b949e;z-index:999;transition:opacity 0.3s;';
routeStatus.textContent = 'ğŸ›£ï¸ Loading driving routes...';
document.body.appendChild(routeStatus);

Promise.all(driveSegments.map(async seg => {
  const coords = await fetchRoute(seg.waypoints);
  if (coords) {
    L.polyline(coords, { color: seg.color, weight: seg.weight, opacity: 0.75, lineJoin: 'round', lineCap: 'round' })
      .bindTooltip(seg.label, { sticky: true, className: 'route-label' }).addTo(map);
  }
})).then(() => {
  routeStatus.style.opacity = '0';
  setTimeout(() => routeStatus.remove(), 400);
}).catch(() => {
  routeStatus.textContent = 'âš ï¸ Route load failed';
  setTimeout(() => routeStatus.remove(), 3000);
});

[{ name:"Ashburton", coords:[-43.9036,171.7280]},{ name:"Methven", coords:[-43.6276,171.6497]},{ name:"Rakaia Gorge", coords:[-43.5800,171.4200]},{ name:"Geraldine", coords:[-44.0978,171.2366]},{ name:"Fairlie", coords:[-44.1022,170.8290]},{ name:"Lake Pukaki", coords:[-44.1772,170.1667]}].forEach(s => {
  L.marker(s.coords, { icon: L.divIcon({ className:'', html:`<div style="width:8px;height:8px;border-radius:50%;background:#3fb950;border:1.5px solid rgba(255,255,255,0.4);opacity:0.7;"></div>`, iconSize:[8,8], iconAnchor:[4,4] })}).bindTooltip(s.name, { direction:'top', offset:[0,-6], className:'route-label' }).addTo(map);
});

[{ name:"Christchurch", coords:[-43.5321,172.6362]},{ name:"Lake Tekapo", coords:[-44.0038,170.4786]},{ name:"Aoraki / Mt Cook", coords:[-43.7359,170.0966]},{ name:"Gibbston Valley", coords:[-45.0132,168.9481]},{ name:"Queenstown", coords:[-45.0312,168.6626]}].forEach(l => {
  L.marker(l.coords, { icon: L.divIcon({ className:'', html:`<div style="background:rgba(22,27,34,0.8);border:1px solid #30363d;border-radius:6px;padding:3px 8px;font-size:11px;font-weight:600;color:#c9d1d9;white-space:nowrap;margin-top:28px;margin-left:-40px;">${l.name}</div>`, iconSize:[0,0] })}).addTo(map);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITINERARY MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const locationGroups = {};
days.forEach((day, idx) => {
  const key = `${day.coords[0]},${day.coords[1]}`;
  if (!locationGroups[key]) locationGroups[key] = [];
  locationGroups[key].push({ day, idx });
});

const dayMarkers = new Array(days.length).fill(null);

days.forEach((day, idx) => {
  const size = day.id === 9 ? 32 : 40;
  const icon = L.divIcon({ className:'', html:`<div class="custom-marker" style="width:${size}px;height:${size}px;background:${day.color};font-size:${day.id===9?10:13}px;">${day.id===9?'âœˆï¸':day.id}</div>`, iconSize:[size,size], iconAnchor:[size/2,size/2] });

  const key = `${day.coords[0]},${day.coords[1]}`;
  const group = locationGroups[key];
  const groupIdx = group.findIndex(g => g.idx === idx);
  const offset = (groupIdx - (group.length-1)/2) * 0.008;
  const coords = [day.coords[0]+offset, day.coords[1]];

  const photoHTML = day.photos&&day.photos[0] ? `<div class="popup-photo-wrap"><img src="${day.photos[0]}" alt="${day.location}" loading="lazy"/><div class="popup-meme-overlay">${day.meme}</div></div>` : '';
  const driveHTML = day.drive ? `<div class="drive-badge">ğŸš— ${day.drive}</div>` : '';
  const stayHTML = day.stay ? `<div class="popup-footer">ğŸ  ${day.stay}</div>` : '';
  const popup = `<div class="popup-inner" style="--popup-color:${day.color}">${photoHTML}<div class="popup-badge">${day.label} Â· ${day.date}</div><div class="popup-title">ğŸ“ ${day.location}</div>${driveHTML}<ul class="popup-items">${day.activities.map(a=>`<li>${a}</li>`).join('')}</ul>${stayHTML}</div>`;

  const marker = L.marker(coords, { icon }).bindPopup(popup, { maxWidth:300 }).addTo(itineraryLayer);
  marker.on('popupopen', () => {
    document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
    const card = document.getElementById(`day-card-${day.id}`);
    if (card) { card.classList.add('active'); card.scrollIntoView({ behavior:'smooth', block:'nearest' }); }
  });
  dayMarkers[idx] = marker;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LODGING MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

locations.forEach(loc => {
  loc.lodging.forEach((l, i) => {
    const offset = (i - (loc.lodging.length-1)/2) * 0.003;
    const icon = L.divIcon({ className:'', html:`<div style="width:32px;height:32px;background:${loc.color};border-radius:50%;border:2px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 3px 12px rgba(0,0,0,0.5);cursor:pointer;">ğŸ </div>`, iconSize:[32,32], iconAnchor:[16,16] });
    const popup = `<div class="popup-inner" style="--popup-color:${loc.color}"><div class="popup-badge">ğŸ  ${loc.name}</div><div class="popup-title">${l.name}</div><ul class="popup-items"><li>${l.type}</li><li>${l.price}</li><li>${l.note}</li></ul></div>`;
    L.marker([l.coords[0]+offset, l.coords[1]], { icon }).bindPopup(popup, { maxWidth:280 }).addTo(lodgingLayer);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DINING MARKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

locations.forEach(loc => {
  loc.dining.forEach((d, i) => {
    const offset = (i - (loc.dining.length-1)/2) * 0.003;
    const icon = L.divIcon({ className:'', html:`<div style="width:32px;height:32px;background:${loc.color};border-radius:50%;border:2px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 3px 12px rgba(0,0,0,0.5);cursor:pointer;">ğŸ½ï¸</div>`, iconSize:[32,32], iconAnchor:[16,16] });
    const popup = `<div class="popup-inner" style="--popup-color:${loc.color}"><div class="popup-badge">ğŸ½ï¸ ${loc.name}</div><div class="popup-title">${d.name}</div><ul class="popup-items"><li>${d.type}</li><li>${d.dish}</li><li>${d.vibe}</li></ul></div>`;
    L.marker([d.coords[0]+offset, d.coords[1]], { icon }).bindPopup(popup, { maxWidth:280 }).addTo(diningLayer);
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderItinerary() {
  const content = document.getElementById('tab-content');
  content.innerHTML = '';
  days.forEach((day, idx) => {
    const card = document.createElement('div');
    card.className = 'day-card';
    card.id = `day-card-${day.id}`;
    card.style.setProperty('--day-color', day.color);
    card.innerHTML = `
      ${carouselHTML(day.photos, day.location)}
      <div class="day-header">
        <div class="day-badge">${day.id}</div>
        <div class="day-meta">
          <div class="day-label">${day.label}</div>
          <div class="day-date">${day.date}</div>
          <div class="day-location">ğŸ“ ${day.location}</div>
        </div>
      </div>
      <div class="day-activities">
        ${day.activities.map(a => `<div class="activity"><span class="dot"></span><span>${a}</span></div>`).join('')}
        ${day.stay ? `<div class="stay-tag">ğŸ  ${day.stay}</div>` : ''}
      </div>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      map.flyTo(day.coords, 11, { duration: 1.2 });
      if (dayMarkers[idx]) dayMarkers[idx].openPopup();
      if (isMobile()) collapseSheet();
    });
    content.appendChild(card);
  });
  setTimeout(initCarousels,0);
}

function renderLodging() {
  const content = document.getElementById('tab-content');
  content.innerHTML = `<div class="section-header"><span>ğŸ  Accommodation Options</span><span class="updated-tag">Updated ${LAST_UPDATED}</span></div>`;
  locations.forEach(loc => {
    const group = document.createElement('div');
    group.className = 'location-group';
    const dayLabels = loc.days.map(d => { const day = days.find(x => x.id === d); return day ? day.label : ''; }).join(', ');
    group.innerHTML = `
      <div class="location-group-header">
        <div class="location-dot" style="background:${loc.color}"></div>
        <div>
          <div class="location-group-name">${loc.name}</div>
          <div class="location-group-days">${dayLabels}</div>
        </div>
      </div>
      ${loc.lodging.map((l, i) => `
        <div class="lodging-card${l.status === 'booked' ? ' is-booked' : ''}" id="lodging-${loc.id}-${i}">
          ${carouselHTML(l.photos,l.name)}
          ${statusBadge(l.status)}
          <div class="lodging-name">${l.name}</div>
          <div class="lodging-meta">
            <span class="lodging-type">${l.type}</span>
            <span class="lodging-price">${l.price}</span>
          </div>
          <div class="lodging-cost">
            <span class="cost-amount">${l.costNote}</span>
            <span class="cost-detail">${l.costDetail}</span>
          </div>
          <div class="lodging-note">${l.note}</div>
          <div class="card-actions">
            <a href="${l.bookingUrl}" target="_blank" rel="noopener" class="card-btn book">ğŸ¨ Book</a>
            <a href="${l.mapsUrl}" target="_blank" rel="noopener" class="card-btn maps">ğŸ“ Maps</a>
          </div>
        </div>
      `).join('')}
    `;
    content.appendChild(group);
  });
  setTimeout(initCarousels,0);
}

function renderDining() {
  const content = document.getElementById('tab-content');
  content.innerHTML = `<div class="section-header"><span>ğŸ½ï¸ Dining Options</span><span class="updated-tag">Updated ${LAST_UPDATED}</span></div>`;
  locations.forEach(loc => {
    const group = document.createElement('div');
    group.className = 'location-group';
    const dayLabels = loc.days.map(d => { const day = days.find(x => x.id === d); return day ? day.label : ''; }).join(', ');
    group.innerHTML = `
      <div class="location-group-header">
        <div class="location-dot" style="background:${loc.color}"></div>
        <div>
          <div class="location-group-name">${loc.name}</div>
          <div class="location-group-days">${dayLabels}</div>
        </div>
      </div>
      ${loc.dining.map((d, i) => `
        <div class="dining-card${d.status === 'booked' ? ' is-booked' : ''}" id="dining-${loc.id}-${i}">
          ${carouselHTML(d.photos,d.name)}
          ${statusBadge(d.status)}
          <div class="dining-name">${d.name}</div>
          <div class="dining-meta">
            <span class="dining-type">${d.type}</span>
          </div>
          <div class="dining-dish">${d.dish}</div>
          <div class="dining-vibe">${d.vibe}</div>
          <div class="card-actions">
            <a href="${d.mapsUrl}" target="_blank" rel="noopener" class="card-btn maps">ğŸ“ Google Maps</a>
          </div>
        </div>
      `).join('')}
    `;
    content.appendChild(group);
  });
  setTimeout(initCarousels,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let activeTab = 'itinerary';

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tab === tab) btn.classList.add('active');
  });
  if (tab === 'itinerary') renderItinerary();
  else if (tab === 'lodging') renderLodging();
  else if (tab === 'dining') renderDining();
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    switchTab(btn.dataset.tab);
    if (isMobile() && !sidebar.classList.contains('open')) {
      sidebar.classList.add('open');
    }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const sidebar = document.getElementById('sidebar');
const handle = document.getElementById('sidebar-handle');
const tabBar = document.getElementById('tab-bar');

function isMobile() { return window.innerWidth <= 640; }

function collapseSheet() {
  sidebar.classList.remove('open');
}

handle.addEventListener('click', () => {
  if (!isMobile()) return;
  sidebar.classList.toggle('open');
});

map.on('click', () => {
  if (isMobile() && sidebar.classList.contains('open')) collapseSheet();
});

// Init
renderItinerary();

setTimeout(() => map.invalidateSize(), 100);
window.addEventListener('resize', () => map.invalidateSize());

</script>
</body>
</html>
